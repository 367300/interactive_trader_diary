{% extends 'core/base.html' %}
{% load static %}
{% load thumbnail %}

{% block title %}{{ object.instrument.ticker }} - {{ object.get_trade_type_display }} - Дневник трейдера{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Краткое резюме -->
            <div class="brief-summary">
                <h5 class="mb-3">
                    <i class="bi bi-info-circle me-2"></i>Краткое резюме
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Инструмент:</strong> {{ object.instrument.ticker }}<br>
                        <strong>Тип операции:</strong> {{ object.get_trade_type_display }}<br>
                        <strong>Направление:</strong> {{ object.get_direction_display }}
                    </div>
                    <div class="col-md-6">
                        <strong>Цена:</strong> {{ object.price }} ₽<br>
                        <strong>Дата:</strong> {{ object.trade_date|date:"d.m.Y H:i" }}
                    </div>
                </div>
            </div>

            <!-- Финансовые параметры -->
            <div class="financial-params">
                <h6 class="mb-3">
                    <i class="bi bi-calculator me-2"></i>Финансовые параметры
                </h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted mb-1">Цена сделки</h6>
                            <h5 class="text-primary mb-0">{{ object.price }} ₽</h5>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted mb-1">Стоп-лосс</h6>
                            <h5 class="text-danger mb-0">
                                {% if object.planned_stop_loss %}{{ object.planned_stop_loss }} ₽{% else %}—{% endif %}
                            </h5>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h6 class="text-muted mb-1">Тейк-профит</h6>
                            <h5 class="text-success mb-0">
                                {% if object.planned_take_profit %}{{ object.planned_take_profit }} ₽{% else %}—{% endif %}
                            </h5>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладки -->
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="tradeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="main-tab" data-bs-toggle="tab" data-bs-target="#main" type="button" role="tab">
                                <i class="bi bi-info-circle me-2"></i>Основная информация
                            </button>
                        </li>
                        {% if child_trades %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="children-tab" data-bs-toggle="tab" data-bs-target="#children" type="button" role="tab">
                                <i class="bi bi-diagram-3 me-2"></i>Связанные сделки
                                <span class="badge bg-primary ms-2">{{ child_trades|length }}</span>
                            </button>
                        </li>
                        {% endif %}
                        {% if object.analysis %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
                                <i class="bi bi-clipboard-data me-2"></i>Анализ сделки
                            </button>
                        </li>
                        {% endif %}
                        {% if object.screenshots.exists %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="screenshots-tab" data-bs-toggle="tab" data-bs-target="#screenshots" type="button" role="tab">
                                <i class="bi bi-images me-2"></i>Скриншоты сделки
                                <span class="badge bg-secondary ms-2">{{ object.screenshots.count }}</span>
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="tradeTabsContent">
                        <!-- Основная информация -->
                        <div class="tab-pane fade show active" id="main" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">Детали сделки</h6>
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>Инструмент:</strong></td>
                                            <td>{{ object.instrument.ticker }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Стратегия:</strong></td>
                                            <td>{{ object.strategy.name|default:"—" }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Тип операции:</strong></td>
                                            <td>{{ object.get_trade_type_display }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Направление:</strong></td>
                                            <td>
                                                <span class="badge bg-{% if object.direction == Trade.Direction.LONG %}success{% else %}danger{% endif %}">
                                                    {{ object.get_direction_display }}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Дата и время:</strong></td>
                                            <td>{{ object.trade_date|date:"d.m.Y H:i" }}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success mb-3">Финансовые данные</h6>
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>Цена:</strong></td>
                                            <td>{{ object.price }} ₽</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Плановый стоп-лосс:</strong></td>
                                            <td>{{ object.planned_stop_loss|default:"—" }} ₽</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Плановый тейк-профит:</strong></td>
                                            <td>{{ object.planned_take_profit|default:"—" }} ₽</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Объем сделки:</strong></td>
                                            <td>
                                                {% if object.trade_type == Trade.TradeType.OPEN %}
                                                    <span class="text-primary fw-bold">{{ object.get_total_volume }}%</span> от капитала (общий)
                                                {% else %}
                                                    <span class="text-info fw-bold">{{ object.get_current_volume }}%</span> от капитала
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Связанные сделки (включая главную) -->
                        {% if child_trades %}
                        <div class="tab-pane fade" id="children" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-warning mb-0">
                                    <i class="bi bi-diagram-3 me-2"></i>Связанные сделки ({{ child_trades|length }})
                                </h6>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="expandAllBtn" onclick="toggleAllAccordions()">
                                        <i class="bi bi-arrows-expand me-1"></i>Развернуть все
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="collapseAllBtn" onclick="toggleAllAccordions()" style="display: none;">
                                        <i class="bi bi-arrows-collapse me-1"></i>Свернуть все
                                    </button>
                                </div>
                            </div>
                            <div class="accordion" id="childTradesAccordion">
                                {% for child_trade in child_trades %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ child_trade.pk }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ child_trade.pk }}" aria-expanded="false" aria-controls="collapse{{ child_trade.pk }}">
                                            <div class="d-flex align-items-center w-100">
                                                <div class="me-3">
                                                    <i class="bi bi-{% if child_trade.trade_type == Trade.TradeType.AVERAGE %}plus-circle{% elif child_trade.trade_type == Trade.TradeType.CLOSE %}x-circle{% else %}play-circle{% endif %} text-{% if child_trade.trade_type == Trade.TradeType.AVERAGE %}warning{% elif child_trade.trade_type == Trade.TradeType.CLOSE %}danger{% else %}primary{% endif %}"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <strong>{{ child_trade.get_trade_type_display }}</strong>
                                                    <span class="text-muted ms-2">{{ child_trade.trade_date|date:"d.m.Y H:i" }}</span>
                                                </div>
                                                <div class="text-end d-flex align-items-center">
                                                    <span class="badge bg-{% if child_trade.direction == Trade.Direction.LONG %}success{% else %}danger{% endif %} me-2">
                                                        {{ child_trade.get_direction_display }}
                                                    </span>
                                                    <strong class="me-3">{{ child_trade.price }} ₽</strong>
                                                </div>
                                            </div>
                                        </button>
                                        <!-- Иконки действий (появляются при наведении) -->
                                        <div class="accordion-actions">
                                            <a href="{% url 'trades:trade_update' child_trade.pk %}" 
                                               class="btn btn-outline-primary btn-sm" 
                                               title="Редактировать сделку"
                                               onclick="event.stopPropagation();">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            {% if child_trade.trade_type != Trade.TradeType.OPEN %}
                                            <button type="button" 
                                                    class="btn btn-outline-danger btn-sm delete-child-trade-btn" 
                                                    title="Удалить сделку"
                                                    data-trade-id="{{ child_trade.pk }}"
                                                    data-trade-type="{{ child_trade.get_trade_type_display }}"
                                                    data-trade-date="{{ child_trade.trade_date|date:"d.m.Y H:i" }}"
                                                    onclick="event.stopPropagation();">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </h2>
                                    <div id="collapse{{ child_trade.pk }}" class="accordion-collapse collapse" aria-labelledby="heading{{ child_trade.pk }}">
                                        <div class="accordion-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6 class="text-primary mb-3">Детали сделки</h6>
                                                    <table class="table table-sm table-borderless">
                                                        <tr>
                                                            <td><strong>Тип:</strong></td>
                                                            <td>{{ child_trade.get_trade_type_display }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Направление:</strong></td>
                                                            <td>
                                                                <span class="badge bg-{% if child_trade.direction == Trade.Direction.LONG %}success{% else %}danger{% endif %}">
                                                                    {{ child_trade.get_direction_display }}
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Цена:</strong></td>
                                                            <td>{{ child_trade.price }} ₽</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Дата:</strong></td>
                                                            <td>{{ child_trade.trade_date|date:"d.m.Y H:i" }}</td>
                                                        </tr>
                                                    </table>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-success mb-3">Планирование</h6>
                                                    <table class="table table-sm table-borderless">
                                                        <tr>
                                                            <td><strong>Стоп-лосс:</strong></td>
                                                            <td>{{ child_trade.planned_stop_loss|default:"—" }} ₽</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Тейк-профит:</strong></td>
                                                            <td>{{ child_trade.planned_take_profit|default:"—" }} ₽</td>
                                                        </tr>
                                                        <tr>
                                                            <td><strong>Объем сделки:</strong></td>
                                                            <td>
                                                                <span class="text-info fw-bold">{{ child_trade.get_current_volume }}%</span> от капитала
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            <!-- Анализ дочерней сделки -->
                                            {% if child_trade.analysis %}
                                            <div class="mt-3">
                                                <h6 class="text-info mb-2">Анализ сделки</h6>
                                                <div class="bg-light p-3 rounded">
                                                    {% if child_trade.analysis.analysis %}
                                                    <p><strong>Анализ:</strong> {{ child_trade.analysis.analysis }}</p>
                                                    {% endif %}
                                                    {% if child_trade.analysis.conclusions %}
                                                    <p><strong>Выводы:</strong> {{ child_trade.analysis.conclusions }}</p>
                                                    {% endif %}
                                                    {% if child_trade.analysis.emotional_state %}
                                                    <p><strong>Эмоциональное состояние:</strong> {{ child_trade.analysis.get_emotional_state_display }}</p>
                                                    {% endif %}
                                                    {% if child_trade.analysis.tags %}
                                                    <p><strong>Теги:</strong> {{ child_trade.analysis.tags|join:", " }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Скриншоты дочерней сделки -->
                                            {% if child_trade.screenshots.exists %}
                                            <div class="mt-3">
                                                <h6 class="text-secondary mb-2">Скриншоты</h6>
                                                <div class="row">
                                                    {% for screenshot in child_trade.screenshots.all|dictsort:"uploaded_at" %}
                                                    <div class="col-md-3 mb-2">
                                                        <div class="card screenshot-card">
                                                            <img src="{% thumbnail screenshot.image 'gallery' %}" class="card-img-top screenshot-thumbnail" alt="Скриншот" data-bs-toggle="modal" data-bs-target="#screenshotModal{{ screenshot.id }}">
                                                            {% if screenshot.description %}
                                                            <div class="card-body p-2">
                                                                <small class="text-muted">{{ screenshot.description }}</small>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Анализ -->
                        {% if object.analysis %}
                        <div class="tab-pane fade" id="analysis" role="tabpanel">
                            <h6 class="text-info mb-3">
                                <i class="bi bi-clipboard-data me-2"></i>Анализ сделки
                            </h6>
                            <div class="bg-light p-4 rounded">
                                {% if object.analysis.analysis %}
                                <div class="mb-3">
                                    <h6 class="text-primary">Анализ</h6>
                                    <p>{{ object.analysis.analysis }}</p>
                                </div>
                                {% endif %}
                                
                                {% if object.analysis.conclusions %}
                                <div class="mb-3">
                                    <h6 class="text-success">Выводы</h6>
                                    <p>{{ object.analysis.conclusions }}</p>
                                </div>
                                {% endif %}
                                
                                <div class="row">
                                    {% if object.analysis.emotional_state %}
                                    <div class="col-md-6">
                                        <h6 class="text-warning">Эмоциональное состояние</h6>
                                        <p>{{ object.analysis.get_emotional_state_display }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    {% if object.analysis.tags %}
                                    <div class="col-md-6">
                                        <h6 class="text-secondary">Теги</h6>
                                        <p>
                                            {% for tag in object.analysis.tags %}
                                            <span class="badge bg-secondary me-1">{{ tag }}</span>
                                            {% endfor %}
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Скриншоты -->
                        {% if object.screenshots.exists %}
                        <div class="tab-pane fade" id="screenshots" role="tabpanel">
                            <h6 class="text-secondary mb-3">
                                <i class="bi bi-images me-2"></i>Скриншоты сделки ({{ object.screenshots.count }})
                            </h6>
                            <div class="screenshot-gallery">
                                {% for screenshot in object.screenshots.all|dictsort:"uploaded_at" %}
                                <div class="card screenshot-card">
                                    <img src="{% thumbnail screenshot.image 'gallery' %}" class="card-img-top screenshot-thumbnail" alt="Скриншот" data-bs-toggle="modal" data-bs-target="#screenshotModal{{ screenshot.id }}">
                                    {% if screenshot.description %}
                                    <div class="card-body">
                                        <p class="card-text">{{ screenshot.description }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Кнопки действий -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <a href="{% url 'trades:trade_update' object.pk %}" class="btn btn-primary">
                            <i class="bi bi-pencil me-2"></i>Редактировать
                        </a>
                        <a href="{% url 'trades:trade_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Назад к списку
                        </a>
                        <a href="{% url 'trades:trade_detail' object.parent_trade.pk %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Назад к родительской сделке
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна для скриншотов основной сделки -->
{% if object.screenshots.exists %}
{% include 'trades/includes/screenshot_modals.html' with screenshots=object.screenshots.all|dictsort:"uploaded_at" is_edit_page=False %}
{% endif %}

<!-- Модальные окна для скриншотов дочерних сделок -->
{% if object.child_trades.exists %}
{% for child_trade in object.child_trades.all %}
{% if child_trade.screenshots.exists %}
{% include 'trades/includes/screenshot_modals.html' with screenshots=child_trade.screenshots.all|dictsort:"uploaded_at" is_edit_page=False %}
{% endif %}
{% endfor %}
{% endif %}

<!-- CSRF токен для AJAX запросов -->
{% csrf_token %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'trades/css/trade_detail.css' %}">
<link rel="stylesheet" href="{% static 'trades/css/screenshots.css' %}">
<style>
/* Стили для иконок действий в аккордеоне */
.accordion-actions {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: none;
    gap: 5px;
    transition: opacity 0.2s ease;
    z-index: 10;
}

.accordion-item:hover .accordion-actions {
    display: flex !important;
}

.accordion-header {
    position: relative;
    min-height: 60px;
}

.accordion-button {
    padding-right: 120px !important; /* Оставляем место для иконок */
}

.accordion-actions .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'trades/js/trade_detail.js' %}"></script>
<script src="{% static 'trades/js/screenshots.js' %}"></script>
<script>
// Обработчик для кнопок удаления дочерних сделок
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.delete-child-trade-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const tradeId = this.getAttribute('data-trade-id');
            const tradeType = this.getAttribute('data-trade-type');
            const tradeDate = this.getAttribute('data-trade-date');
            confirmDeleteChildTrade(tradeId, tradeType, tradeDate);
        });
    });
});
</script>
{% endblock %}
