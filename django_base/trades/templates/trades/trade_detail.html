{% extends 'core/base.html' %}
{% load static %}

{% block title %}Сделка {{ trade.instrument.ticker }} - Дневник трейдера{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-0">
                    <i class="bi bi-journal-text me-2"></i>Сделка {{ trade.instrument.ticker }}
                </h1>
                <p class="text-muted">{{ trade.trade_date|date:"d.m.Y H:i" }} • {{ trade.get_direction_display }}</p>
            </div>
            <div class="btn-group">
                <a href="{% url 'trades:trade_update' trade.pk %}" class="btn btn-outline-primary">
                    <i class="bi bi-pencil me-2"></i>Редактировать
                </a>
                <a href="{% url 'trades:trade_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Назад к списку
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Основная информация -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-soft">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle me-2"></i>Основная информация
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-sm-6">
                        <strong>Инструмент:</strong>
                        <div class="text-muted">{{ trade.instrument.name }}</div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Стратегия:</strong>
                        <div class="text-muted">
                            {% if trade.strategy %}
                                {{ trade.strategy.name }}
                            {% else %}
                                Не указана
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Дата и время:</strong>
                        <div class="text-muted">{{ trade.trade_date|date:"d.m.Y H:i" }}</div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Сессия:</strong>
                        <div class="text-muted">{{ trade.get_trading_session_display }}</div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Направление:</strong>
                        <div>
                            {% if trade.direction == 'LONG' %}
                                <span class="badge bg-success fs-6">Лонг</span>
                            {% else %}
                                <span class="badge bg-danger fs-6">Шорт</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Статус:</strong>
                        <div>
                            {% if trade.is_closed %}
                                <span class="badge bg-success fs-6">Закрыта</span>
                            {% else %}
                                <span class="badge bg-warning fs-6">Открыта</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Финансовые параметры -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-soft">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calculator me-2"></i>Финансовые параметры
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-sm-6">
                        <strong>Цена входа:</strong>
                        <div class="h5 text-primary">{{ trade.entry_price }} ₽</div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Цена выхода:</strong>
                        <div class="h5 text-secondary">
                            {% if trade.exit_price %}
                                {{ trade.exit_price }} ₽
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Количество:</strong>
                        <div class="h5">{{ trade.quantity }}</div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Плечо:</strong>
                        <div class="h5">{{ trade.leverage }}x</div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Комиссия:</strong>
                        <div class="h5 text-warning">{{ trade.commission }} ₽</div>
                    </div>
                    <div class="col-sm-6">
                        <strong>Результат:</strong>
                        <div class="h4 {% if trade.actual_result_rub >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if trade.actual_result_rub %}
                                {% if trade.actual_result_rub >= 0 %}+{% endif %}{{ trade.actual_result_rub|floatformat:2 }} ₽
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Планирование -->
    {% if trade.planned_stop_loss or trade.planned_take_profit %}
    <div class="col-lg-6">
        <div class="card border-0 shadow-soft">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="bi bi-target me-2"></i>Планирование
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% if trade.planned_stop_loss %}
                    <div class="col-sm-6">
                        <strong>Плановый стоп-лосс:</strong>
                        <div class="h5 text-danger">{{ trade.planned_stop_loss }} пунктов</div>
                    </div>
                    {% endif %}
                    {% if trade.planned_take_profit %}
                    <div class="col-sm-6">
                        <strong>Плановый тейк-профит:</strong>
                        <div class="h5 text-success">{{ trade.planned_take_profit }} пунктов</div>
                    </div>
                    {% endif %}
                    {% if trade.actual_result_points %}
                    <div class="col-sm-6">
                        <strong>Фактический результат:</strong>
                        <div class="h5 {% if trade.actual_result_points >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if trade.actual_result_points >= 0 %}+{% endif %}{{ trade.actual_result_points }} пунктов
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Анализ сделки -->
    {% if analysis %}
    <div class="col-lg-6">
        <div class="card border-0 shadow-soft">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightbulb me-2"></i>Анализ сделки
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Основание для входа:</strong>
                    <div class="text-muted mt-1">{{ analysis.entry_reason|linebreaks }}</div>
                </div>
                
                {% if analysis.exit_reason %}
                <div class="mb-3">
                    <strong>Основание для закрытия:</strong>
                    <div class="text-muted mt-1">{{ analysis.exit_reason|linebreaks }}</div>
                </div>
                {% endif %}
                
                {% if analysis.analysis %}
                <div class="mb-3">
                    <strong>Анализ действий:</strong>
                    <div class="text-muted mt-1">{{ analysis.analysis|linebreaks }}</div>
                </div>
                {% endif %}
                
                {% if analysis.conclusions %}
                <div class="mb-3">
                    <strong>Выводы:</strong>
                    <div class="text-muted mt-1">{{ analysis.conclusions|linebreaks }}</div>
                </div>
                {% endif %}
                
                {% if analysis.emotional_state %}
                <div class="mb-3">
                    <strong>Эмоциональное состояние:</strong>
                    <div>
                        <span class="badge bg-info">{{ analysis.get_emotional_state_display }}</span>
                    </div>
                </div>
                {% endif %}
                
                {% if analysis.tags %}
                <div class="mb-0">
                    <strong>Теги:</strong>
                    <div class="mt-1">
                        {% for tag in analysis.tags %}
                            <span class="badge bg-secondary me-1">{{ tag }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Скриншоты -->
    {% if screenshots %}
    <div class="col-12">
        <div class="card border-0 shadow-soft">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">
                    <i class="bi bi-image me-2"></i>Скриншоты
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for screenshot in screenshots %}
                    <div class="col-md-4">
                        <div class="card border">
                            <img src="{{ screenshot.image.url }}" class="card-img-top" alt="{{ screenshot.description }}">
                            <div class="card-body p-2">
                                <small class="text-muted">
                                    {% if screenshot.description %}
                                        {{ screenshot.description }}
                                    {% else %}
                                        Скриншот от {{ screenshot.uploaded_at|date:"d.m.Y H:i" }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.badge {
    font-size: 0.875rem;
}
</style>
{% endblock %}
